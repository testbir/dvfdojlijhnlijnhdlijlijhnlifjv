# catalog_service/Dockerfile

FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º postgresql-client –¥–ª—è pg_isready
RUN apt-get update && apt-get install -y \
    postgresql-client \
    curl \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
COPY . .

# –°–æ–∑–¥–∞–µ–º init_db.sh –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
RUN echo '#!/bin/bash\n\
set -e\n\
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ PostgreSQL..."\n\
export PGPASSWORD=$POSTGRES_PASSWORD\n\
until pg_isready -h ${POSTGRES_HOST:-postgres} -U ${POSTGRES_USER:-postgres}; do\n\
  echo "PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∂–¥–µ–º..."\n\
  sleep 2\n\
done\n\
echo "‚úÖ PostgreSQL –≥–æ—Ç–æ–≤!"\n\
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."' > /app/init_db.sh

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
RUN chmod +x /app/init_db.sh

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
CMD ["sh", "-c", "./init_db.sh && python -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload"]